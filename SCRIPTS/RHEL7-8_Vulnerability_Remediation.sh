#!/bin/bash
### Linux Vulnerability Management Script
/usr/bin/mkdir /tmp/RemediationLog
/usr/bin/echo "### Run the following commands to set ownership and permissions on /etc/cron.monthly:" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "Old setting for /etc/cron.monthly" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -ld /etc/cron.monthly >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/chown root:root /etc/cron.monthly 
/usr/bin/chmod og-rwx /etc/cron.monthly
/usr/bin/echo "New setting for /etc/cron.monthly" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -ld /etc/cron.monthly >> /tmp/RemediationLog/RemediationLog.out

/usr/bin/echo "### Run the following commands to set ownership and permissions on /etc/cron.weekly:" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "Old setting for /etc/cron.weekly" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/cron.weekly >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/chown root:root /etc/cron.weekly 
/usr/bin/chmod og-rwx /etc/cron.weekly
/usr/bin/echo "New setting for /etc/cron.weekly" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/cron.weekly >> /tmp/RemediationLog/RemediationLog.out

/usr/bin/echo "### Run the following commands to set ownership and permissions on /etc/crontab:" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "Old setting for /etc/crontab" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/crontab >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/chown root:root /etc/crontab 
/usr/bin/chmod og-rwx /etc/crontab
/usr/bin/echo "New setting for /etc/crontab" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/crontab >> /tmp/RemediationLog/RemediationLog.out

/usr/bin/echo "### Run the following commands to remove /etc/cron.deny and /etc/at.deny and create and set permissions and ownership for /etc/cron.allow and /etc/at.allow :" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "Old setting for /etc/cron.deny" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/cron.deny >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "Old setting for /etc/at.deny" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/at.deny >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/mv /etc/cron.deny /tmp/RemediationLog/
/usr/bin/mv /etc/at.deny /tmp/RemediationLog/
/usr/bin/touch /etc/cron.allow 
### Adding accounts already using cron
/usr/bin/ls -ltr /var/spool/cron/|grep -v total|awk '{print $NF}' >> /etc/cron.allow
/usr/bin/touch /etc/at.allow 
/usr/bin/chmod og-rwx /etc/cron.allow 
/usr/bin/chmod og-rwx /etc/at.allow 
/usr/bin/chown root:root /etc/cron.allow 
/usr/bin/chown root:root /etc/at.allow
/usr/bin/echo "New setting for /etc/cron.deny" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/cron.deny >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "New setting for /etc/at.deny" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/at.deny >> /tmp/RemediationLog/RemediationLog.out

/usr/bin/echo "### To secure /etc/anacrontab file:Execute the following commands." >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "Old setting for /etc/anacrontab" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/anacrontab >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/chown root:root /etc/anacrontab 
/usr/bin/chmod og-rwx /etc/anacrontab
/usr/bin/echo "New setting for /etc/anacrontab" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/anacrontab >> /tmp/RemediationLog/RemediationLog.out

/usr/bin/echo "### Run the following commands to set ownership and permissions on /etc/cron.hourly" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "Old setting for /etc/cron.hourly" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -ld /etc/cron.hourly >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/chown root:root /etc/cron.hourly 
/usr/bin/chmod og-rwx /etc/cron.hourly
/usr/bin/echo "New setting for /etc/cron.hourly" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -ld /etc/cron.hourly >> /tmp/RemediationLog/RemediationLog.out

/usr/bin/echo "### Add the following lines to the /etc/audit/audit.rules file: -w /var/log/sudo.log -p wa -k actions 2." >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/cp /etc/audit/rules.d/audit.rules /tmp/RemediationLog/audit.rules-addinglog
/usr/bin/echo "-w /var/log/sudo.log -p wa -k actions 2" >> /etc/audit/rules.d/audit.rules
##Execute the following command to restart auditd # pkill -HUP -P 1 auditd
/usr/sbin/service auditd restart
/usr/bin/cp /etc/sudoers /tmp/RemediationLog/sudoers-addinglog
/usr/bin/sed -i '/# Defaults specification/a\
Defaults logfile=/var/log/sudo.log' /etc/sudoers

/usr/bin/echo "Set the following parameters in the /etc/sysctl.conf file:" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/cp /etc/sysctl.conf /tmp/RemediationLog/
/usr/bin/echo "net.ipv6.conf.all.accept_ra = 0" >> /etc/sysctl.conf
/usr/bin/echo "net.ipv6.conf.default.accept_ra = 0" >> /etc/sysctl.conf
### Run the following commands to set the active kernel parameters:
/usr/sbin/sysctl -w net.ipv6.conf.all.accept_ra=0 
/usr/sbin/sysctl -w net.ipv6.conf.default.accept_ra=0 
/usr/sbin/sysctl -w net.ipv6.route.flush=1

/usr/bin/echo "Set the following parameters in the /etc/sysctl.conf file:" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "net.ipv4.conf.all.log_martians = 1" >> /etc/sysctl.conf
/usr/bin/echo "net.ipv4.conf.default.log_martians = 1" >> /etc/sysctl.conf
### Run the following commands to set the active kernel parameters: 
/usr/sbin/sysctl -w net.ipv4.conf.all.log_martians=1 
/usr/sbin/sysctl -w net.ipv4.conf.default.log_martians=1 
/usr/sbin/sysctl -w net.ipv4.route.flush=1

/usr/bin/echo "### Run the following command to set permissions on /etc/group- & /etc/gshadow-:" >> /tmp/RemediationLog/RemediationLog.out 
/usr/bin/echo "Old setting for /etc/group-" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/group- >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/chown root:root /etc/group- 
/usr/bin/chmod 600 /etc/group-
/usr/bin/echo "New setting for /etc/group-" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/group- >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/echo "Old setting for /etc/gshadow-" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/gshadow- >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/chown root:root /etc/gshadow- 
/usr/bin/chmod 600 /etc/gshadow-
/usr/bin/echo "New setting for /etc/gshadow-" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/ls -l /etc/gshadow- >> /tmp/RemediationLog/RemediationLog.out

## Backing up /etc/pam.d
/usr/bin/tar -cvf /tmp/RemediationLog/pam.tar /etc/pam.d 

/usr/bin/echo "### Edit the /etc/pam.d/password-auth and /etc/pam.d/system-auth files to include the remember option and conform to site policy as shown:" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/cp /etc/pam.d/password-auth /tmp/RemediationLog/
/usr/bin/cp /etc/pam.d/system-auth /tmp/RemediationLog/
/usr/bin/echo "password sufficient pam_unix.so remember=5" >> /etc/pam.d/password-auth
/usr/bin/echo "password sufficient pam_unix.so remember=5" >> /etc/pam.d/system-auth

/usr/bin/echo "### Edit the /etc/ssh/sshd_config file to set the parameter as follows: X11Forwarding no" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/perl -pi.back.sec.remediation -e 's/X11Forwarding yes/X11Forwarding no/g;' /etc/ssh/sshd_config

/usr/bin/echo "### If GDM is installed on the system verify that /etc/dconf/profile/gdm exists and contains the following" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/mv /etc/dconf/profile/gdm /tmp/RemediationLog/
/usr/bin/touch /etc/dconf/profile/gdm
/usr/bin/echo "user-db:user" > /etc/dconf/profile/gdm
/usr/bin/echo "system-db:gdm" >> /etc/dconf/profile/gdm
/usr/bin/echo "file-db:/usr/share/gdm/greeter-dconf-defaults" >> /etc/dconf/profile/gdm
/usr/bin/chmod 644 /etc/dconf/profile/gdm
/usr/bin/dconf update

/usr/bin/mv /etc/dconf/db/gdm.d/01-banner-message /tmp/RemediationLog/
/usr/bin/touch /etc/dconf/db/gdm.d/01-banner-message
/usr/bin/echo "[org/gnome/login-screen]" > /etc/dconf/db/gdm.d/01-banner-message
/usr/bin/echo "banner-message-enable=true" >> /etc/dconf/db/gdm.d/01-banner-message
/usr/bin/echo "banner-message-text=\"Authorized access only. This system is the property of Livingston International. Disconnect IMMEDIATELY if you are not an authorized user! All connection attempts are logged and monitored. All unauthorized connection attempts will be investigated and handed over to the proper authorities.\""  >> /etc/dconf/db/gdm.d/01-banner-message
/usr/bin/chmod 644 /etc/dconf/db/gdm.d/01-banner-message
/usr/bin/dconf update

/usr/bin/echo "### Run the following command and verify that the noexec option is set on /dev/shm" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/cp /etc/fstab /tmp/RemediationLog/
/usr/bin/echo "tmpfs   /dev/shm    tmpfs   noexec,rw,nosuid,nodev,seclabel 0   0" >> /etc/fstab
/usr/bin/mount -o remount,noexec /dev/shm

/usr/bin/cp /etc/ssh/sshd_config /tmp/RemediationLog/
/usr/bin/perl -pi.back.sec.remediationBANNER -e 's/#Banner none/Banner \/etc\/issue.net/g' /etc/ssh/sshd_config
/usr/bin/echo "##############################################################" > /etc/issue.net
/usr/bin/echo "#  Authorized access only.                                   #" >> /etc/issue.net  
/usr/bin/echo "#  This system is the property of LIVINGSTON INTERNATIONAL,  #" >> /etc/issue.net
/usr/bin/echo "#  Disconnect IMMEDIATELY if you are not an authorized user! #" >> /etc/issue.net
/usr/bin/echo "#  All connection attempts are logged and monitored.         #" >> /etc/issue.net
/usr/bin/echo "#  All unauthorized connection attempts will be investigated #" >> /etc/issue.net 
/usr/bin/echo "#  and handed over to the proper authorities.                #" >> /etc/issue.net
/usr/bin/echo "##############################################################" >> /etc/issue.net
/usr/bin/perl -pi.back.sec.remediationLOGLEVEL -e 's/#LogLevel INFO/LogLevel INFO/g' /etc/ssh/sshd_config
/usr/bin/perl -pi.back.sec.remediationMaxAuthTries -e 's/#MaxAuthTries 6/MaxAuthTries 4/g' /etc/ssh/sshd_config
/usr/bin/cp /etc/motd /etc/motdOLD
/usr/bin/truncate -s 0 /etc/motd
/usr/bin/systemctl restart sshd

/usr/bin/echo "### Edit the /etc/ssh/sshd_config file to set the parameter as follows: X11Forwarding no" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/perl -pi.back.sec.remediation -e 's/X11Forwarding yes/X11Forwarding no/g;' /etc/ssh/sshd_config
/usr/bin/systemctl restart sshd

/usr/bin/echo "### 1. Set the PASS_MIN_DAYS parameter to 1 in /etc/login.defs" >> /tmp/RemediationLog/RemediationLog.out
/usr/bin/perl -pi.back.sec.remediation -e 's/PASS_MIN_DAYS	0/PASS_MIN_DAYS	1/g;' /etc/login.defs

#/usr/bin/echo "### 1. Set the PASS_MAX_DAYS parameter to 90 in /etc/login.defs" >> /tmp/RemediationLog/RemediationLog.out
#/usr/bin/perl -pi.back.sec.remediation -e 's/PASS_MAX_DAYS   99999/PASS_MAX_DAYS   90/g;' /etc/login.defs

/usr/bin/cp /etc/security/pwquality.conf /tmp/RemediationLog/pwquality.conf_NewLimits
/usr/bin/sed -i '/# minlen =/a\
minlen = 14' /etc/security/pwquality.conf
/usr/bin/sed -i '/# dcredit =/a\
dcredit = -1' /etc/security/pwquality.conf
/usr/bin/sed -i '/# ucredit =/a\
ucredit = -1' /etc/security/pwquality.conf
/usr/bin/sed -i '/# ocredit =/a\
ocredit = -1' /etc/security/pwquality.conf
/usr/bin/sed -i '/# lcredit =/a\
lcredit = -1' /etc/security/pwquality.conf

/usr/bin/cp /etc/ssh/sshd_config /tmp/RemediationLog/sshd_config_Protocol
/usr/bin/echo "Protocol 2" >> /etc/ssh/sshd_config
/usr/bin/systemctl restart sshd

exit
